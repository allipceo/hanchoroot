# 노션 데이터와 window.CORE_DATA 동기화 프로세스 가이드

**문서 번호**: 049  
**작성일**: 2025년 9월 14일  
**작성자**: 서대리 (AI Assistant)  
**검토자**: 조대표님  
**버전**: 1.0  
**적용범위**: 한양조씨 족보앱 데이터 동기화 시스템

---

## 📋 **문서 개요**

### **목적**
- 노션 데이터베이스와 window.CORE_DATA 동기화 프로세스 완전 문서화
- 새로운 브랜치에서 참고할 수 있는 표준 가이드 제공
- V4.0 단일소스 시스템의 핵심 동기화 메커니즘 설명
- 자동화된 동기화 스크립트 사용법 및 코드 위치 안내

### **배경**
- V4.0 단일소스 시스템 구축 완료
- 노션 데이터베이스가 최상위 데이터 소스
- window.CORE_DATA가 애플리케이션의 유일한 데이터 소스
- 조대표님이 노션에서 직접 데이터 수정 시 자동 반영 필요

---

## 🎯 **동기화 시스템 개요**

### **1. 시스템 아키텍처**
```
노션 데이터베이스 (최상위 소스)
         ↓
    [동기화 스크립트]
         ↓
   window.CORE_DATA (애플리케이션 소스)
         ↓
    [모든 애플리케이션 모듈]
```

### **2. 핵심 원칙**
- **단일 소스**: 노션 데이터베이스가 유일한 원본
- **자동 동기화**: 수동 작업 없이 자동으로 동기화
- **완전 일치**: 노션과 window.CORE_DATA 100% 일치
- **필드명 통일**: 모든 필드명이 노션과 동일

---

## 🔧 **동기화 프로세스 상세**

### **1. 전체 동기화 프로세스**

#### **단계별 프로세스**
1. **노션 데이터 로드**: Notion API를 통해 최신 데이터 가져오기
2. **데이터 변환**: 노션 형식을 window.CORE_DATA 형식으로 변환
3. **필드명 통일**: 모든 필드명을 노션과 일치시키기
4. **검색 인덱스 생성**: 빠른 검색을 위한 인덱스 생성
5. **core_browser.js 생성**: 브라우저용 데이터 파일 생성
6. **검증**: 동기화 결과 검증

#### **실행 명령어**
```bash
# 프로젝트 루트에서
cd data
node sync_notion_to_core.js
```

### **2. 핵심 스크립트 위치 및 역할**

#### **메인 동기화 스크립트**
- **파일 위치**: `data/sync_notion_to_core.js`
- **역할**: 전체 동기화 프로세스 오케스트레이션
- **실행 주기**: 노션 데이터 수정 시마다 실행

#### **데이터 검증 스크립트**
- **파일 위치**: `data/verify_data_match.js`
- **역할**: 노션 데이터와 window.CORE_DATA 일치 여부 검증
- **실행 시점**: 동기화 후 검증

#### **노션 데이터 가져오기 스크립트**
- **파일 위치**: `data/complete_notion_fetch.js`
- **역할**: Notion API를 통한 원시 데이터 가져오기
- **출력**: `data/notion_data_complete.json`

#### **데이터 변환 스크립트**
- **파일 위치**: `data/notion_converter.js`
- **역할**: 노션 데이터를 애플리케이션 형식으로 변환
- **출력**: `data/converted_data.json`

---

## 📁 **파일 구조 및 역할**

### **1. 데이터 디렉토리 구조**
```
data/
├── sync_notion_to_core.js          # 메인 동기화 스크립트
├── verify_data_match.js            # 데이터 검증 스크립트
├── complete_notion_fetch.js        # 노션 데이터 가져오기
├── notion_converter.js             # 데이터 변환
├── create_core_browser.js          # 브라우저용 데이터 생성
├── core_browser.js                 # 최종 브라우저용 데이터 파일
├── notion_data_complete.json       # 노션 원시 데이터
└── converted_data.json             # 변환된 중간 데이터
```

### **2. 각 파일의 상세 역할**

#### **sync_notion_to_core.js (메인 스크립트)**
```javascript
// 핵심 기능
1. 노션 데이터 로드
2. 데이터 변환 및 필드명 통일
3. 검색 인덱스 생성
4. core_browser.js 파일 생성
5. 동기화 통계 출력
```

#### **verify_data_match.js (검증 스크립트)**
```javascript
// 핵심 기능
1. 노션 데이터와 window.CORE_DATA 로드
2. 인원 수 일치 여부 확인
3. 이름별 일치 여부 확인
4. 특정 인물 상세 필드 비교
5. 필드명 일치 여부 확인
```

---

## 🚀 **동기화 실행 방법**

### **1. 기본 동기화 실행**

#### **PowerShell에서 실행**
```powershell
# 프로젝트 루트에서
cd data
node sync_notion_to_core.js
```

#### **예상 출력**
```
=== 노션 데이터와 window.CORE_DATA 완전 동기화 시작 ===

1. 노션 데이터 로드...
✅ 노션 데이터 로드 완료: 152명

2. 노션 데이터 이름 기준 정렬...
✅ 노션 데이터 정렬 완료

3. 노션 데이터를 window.CORE_DATA 형식으로 변환...
변환 완료: 조은상 (G4M131S)
...

4. 변환된 데이터 이름 기준 정렬...
✅ 변환된 데이터 정렬 완료

5. window.CORE_DATA 형식으로 구성...

6. 검색 인덱스 생성...
✅ 검색 인덱스 생성 완료

7. core_browser.js 파일 생성...
✅ core_browser.js 파일 생성 완료

=== 동기화 완료 통계 ===
총 인원: 152명
세대별 분포: { '5세대': 76, '4세대': 47, '3세대': 16, ... }
Line별 분포: { Line1: 74, Line2: 34, Line3: 41, '공통': 3 }
생존상태별 분포: { '생존': 129, '고인': 21, '미확인': 2 }

=== 필드명 일치 확인 ===
✅ 노션 필드명과 window.CORE_DATA 필드명 완전 일치
```

### **2. 데이터 검증 실행**

#### **검증 명령어**
```powershell
node verify_data_match.js
```

#### **예상 출력**
```
=== 노션 데이터와 window.CORE_DATA 일치 여부 상세 검증 ===

1. 노션 데이터 로드...
✅ 노션 데이터 로드 완료: 152명

2. window.CORE_DATA 로드...
✅ window.CORE_DATA 로드 완료: 152명

3. 기본 통계 비교...
노션 데이터: 152명
window.CORE_DATA: 152명
✅ 인원 수 일치

4. 이름 기준 정렬 및 비교...
✅ 이름 일치: 152/152

5. 특정 인물 상세 비교 (조은상)...
✅ 조은상 데이터 양쪽 모두 존재

📋 조은상 상세 필드 비교:
세대: 노션="4", CORE="4" ✅
성별: 노션="M", CORE="M" ✅
Line1: 노션="Line3", CORE="Line3" ✅
생년: 노션="1963", CORE="1963" ✅
생존상태: 노션="생존", CORE="생존" ✅

=== 최종 검증 결과 ===
✅ 인원 수: 일치
✅ 이름 일치율: 100%
✅ 필드명: 완전 일치
✅ 데이터 구조: 일치

🎉 노션 데이터와 window.CORE_DATA가 완전히 일치합니다!
```

---

## 🔍 **핵심 코드 분석**

### **1. 메인 동기화 스크립트 핵심 로직**

#### **파일**: `data/sync_notion_to_core.js`
```javascript
// 1. 노션 데이터 로드
const notionData = await fetchNotionData();
console.log(`✅ 노션 데이터 로드 완료: ${notionData.length}명`);

// 2. 데이터 변환
const convertedData = convertNotionToJSON(notionData);
console.log(`✅ 데이터 변환 완료: ${convertedData.persons.length}명`);

// 3. 검색 인덱스 생성
const searchIndex = createSearchIndex(convertedData.persons);
console.log(`✅ 검색 인덱스 생성 완료`);

// 4. window.CORE_DATA 형식으로 구성
const coreData = {
    config: {
        app: {
            version: "V4.0",
            dataVersion: new Date().toISOString(),
            lastUpdated: new Date().toISOString()
        },
        admin: {
            name: "조대표님",
            email: "admin@example.com"
        }
    },
    persons: convertedData.persons,
    searchIndex: searchIndex,
    statistics: convertedData.statistics
};

// 5. core_browser.js 파일 생성
const browserContent = `// 한양조씨 족보앱 Core Data (V4.0)
// 자동 생성됨: ${new Date().toISOString()}
// 노션 데이터와 완전 동기화

const CORE_DATA = ${JSON.stringify(coreData, null, 2)};

// 전역 객체로 노출
if (typeof window !== 'undefined') {
    window.CORE_DATA = CORE_DATA;
}

// Node.js 환경에서도 사용 가능하도록
if (typeof module !== 'undefined' && module.exports) {
    module.exports = CORE_DATA;
}`;

fs.writeFileSync('./core_browser.js', browserContent, 'utf8');
console.log(`✅ core_browser.js 파일 생성 완료`);
```

### **2. 데이터 변환 핵심 로직**

#### **파일**: `data/notion_converter.js`
```javascript
// 필드명 매핑 (1:1 매핑으로 노션과 완전 일치)
const FIELD_MAPPING = {
    '세대': '세대',
    '성별': '성별', 
    'Line1': 'Line1',
    '생년': '생년',
    '생존상태': '생존상태',
    '한자명': '한자명',
    '사망일': '사망일',
    '비고': '비고'
};

// 데이터 변환 함수
function convertNotionToJSON(notionData) {
    const converted = {
        persons: [],
        statistics: {
            total: 0,
            byGeneration: {},
            byLine: {},
            byStatus: {}
        }
    };

    notionData.forEach(person => {
        const convertedPerson = {
            id: generateId(person),
            name: person.properties.이름?.title?.[0]?.text?.content || '',
            세대: person.properties.세대?.number || 0,
            성별: person.properties.성별?.select?.name || '',
            Line1: person.properties.Line1?.select?.name || '',
            생년: person.properties.생년?.number || null,
            생존상태: person.properties.생존상태?.select?.name || '미확인',
            한자명: person.properties.한자명?.rich_text?.[0]?.text?.content || '',
            사망일: person.properties.사망일?.date?.start || null,
            비고: person.properties.비고?.rich_text?.[0]?.text?.content || '',
            relationships: {
                father: person.properties.부?.rich_text?.[0]?.text?.content || '',
                mother: person.properties.모?.rich_text?.[0]?.text?.content || '',
                spouses: person.properties.배우자?.multi_select?.map(s => s.name) || []
            },
            contact: {
                phone: person.properties.전화번호?.phone_number || '',
                email: person.properties.이메일?.email || '',
                address: person.properties.주소?.rich_text?.[0]?.text?.content || ''
            },
            additional: {
                job: person.properties.직업?.rich_text?.[0]?.text?.content || '',
                education: person.properties.학력?.rich_text?.[0]?.text?.content || '',
                notes: person.properties.비고?.rich_text?.[0]?.text?.content || ''
            }
        };

        converted.persons.push(convertedPerson);
    });

    return converted;
}
```

### **3. 검증 스크립트 핵심 로직**

#### **파일**: `data/verify_data_match.js`
```javascript
// 데이터 일치 여부 검증
function verifyDataMatch() {
    // 1. 노션 데이터 로드
    const notionData = JSON.parse(fs.readFileSync('./notion_data_complete.json', 'utf8'));
    
    // 2. window.CORE_DATA 로드
    const coreContent = fs.readFileSync('./core_browser.js', 'utf8');
    const match = coreContent.match(/const CORE_DATA = ([\s\S]*?);/);
    const coreData = JSON.parse(match[1]);
    
    // 3. 기본 통계 비교
    console.log(`노션 데이터: ${notionData.length}명`);
    console.log(`window.CORE_DATA: ${coreData.persons.length}명`);
    
    if (notionData.length === coreData.persons.length) {
        console.log('✅ 인원 수 일치');
    } else {
        console.error('❌ 인원 수 불일치');
    }
    
    // 4. 이름별 일치 여부 확인
    const notionNames = notionData.map(p => p.properties.이름?.title?.[0]?.text?.content).sort();
    const coreNames = coreData.persons.map(p => p.name).sort();
    
    let matchCount = 0;
    notionNames.forEach((name, index) => {
        if (name === coreNames[index]) {
            matchCount++;
        }
    });
    
    console.log(`✅ 이름 일치: ${matchCount}/${notionNames.length}`);
    
    // 5. 특정 인물 상세 비교
    const testPerson = '조은상';
    const notionPerson = notionData.find(p => p.properties.이름?.title?.[0]?.text?.content === testPerson);
    const corePerson = coreData.persons.find(p => p.name === testPerson);
    
    if (notionPerson && corePerson) {
        console.log(`✅ ${testPerson} 데이터 양쪽 모두 존재`);
        
        // 필드별 상세 비교
        const fields = ['세대', '성별', 'Line1', '생년', '생존상태'];
        fields.forEach(field => {
            const notionValue = notionPerson.properties[field]?.number || 
                               notionPerson.properties[field]?.select?.name || 
                               notionPerson.properties[field]?.rich_text?.[0]?.text?.content;
            const coreValue = corePerson[field];
            
            if (notionValue == coreValue) {
                console.log(`${field}: 노션="${notionValue}", CORE="${coreValue}" ✅`);
            } else {
                console.log(`${field}: 노션="${notionValue}", CORE="${coreValue}" ❌`);
            }
        });
    }
}
```

---

## 📊 **동기화 결과 및 통계**

### **1. 표준 동기화 결과**

#### **인원 통계**
- **총 인원**: 152명
- **세대별 분포**: 1세대(3명), 2세대(5명), 3세대(16명), 4세대(47명), 5세대(76명), 6세대(5명)
- **Line별 분포**: Line1(74명), Line2(34명), Line3(41명), 공통(3명)
- **생존상태별 분포**: 생존(129명), 고인(21명), 미확인(2명)

#### **검증 결과**
- **인원 수 일치**: ✅ 152명
- **이름 일치율**: ✅ 100% (152/152)
- **필드명 일치**: ✅ 완전 일치
- **데이터 구조**: ✅ 일치

### **2. 성공 기준**

#### **동기화 성공 기준**
- ✅ 노션 데이터 로드 성공
- ✅ 데이터 변환 성공
- ✅ 검색 인덱스 생성 성공
- ✅ core_browser.js 파일 생성 성공
- ✅ 검증 통과

#### **검증 성공 기준**
- ✅ 인원 수 일치
- ✅ 이름 일치율 100%
- ✅ 필드명 완전 일치
- ✅ 특정 인물 상세 필드 일치

---

## 🚨 **문제 해결 가이드**

### **1. 일반적인 문제 및 해결방법**

#### **문제**: "노션 데이터 로드 실패"
```bash
# 해결방법
1. Notion API 키 확인
2. 데이터베이스 ID 확인
3. 네트워크 연결 확인
4. Notion API 권한 확인
```

#### **문제**: "데이터 변환 실패"
```bash
# 해결방법
1. 노션 데이터 구조 확인
2. 필드명 매핑 확인
3. 데이터 타입 확인
4. 필수 필드 누락 확인
```

#### **문제**: "검증 실패"
```bash
# 해결방법
1. 동기화 재실행
2. 캐시 파일 삭제
3. 수동 검증 실행
4. 로그 확인
```

### **2. 디버깅 명령어**

#### **개별 스크립트 실행**
```bash
# 노션 데이터만 가져오기
node complete_notion_fetch.js

# 데이터 변환만 실행
node notion_converter.js

# 검증만 실행
node verify_data_match.js
```

#### **로그 확인**
```bash
# 상세 로그와 함께 실행
node sync_notion_to_core.js 2>&1 | tee sync.log
```

---

## 🔄 **자동화 및 스케줄링**

### **1. 수동 실행 (현재 방식)**
```bash
# 조대표님이 노션 데이터 수정 후
cd data
node sync_notion_to_core.js
node verify_data_match.js
```

### **2. 자동화 방안 (향후)**

#### **Notion Webhook 연동**
```javascript
// 향후 구현 예정
app.post('/notion-webhook', (req, res) => {
    console.log('노션 데이터 변경 감지');
    exec('node sync_notion_to_core.js', (error, stdout, stderr) => {
        if (error) {
            console.error('동기화 실패:', error);
        } else {
            console.log('동기화 완료:', stdout);
        }
    });
    res.status(200).send('OK');
});
```

#### **Cron Job 설정**
```bash
# 매일 오전 9시에 동기화 실행
0 9 * * * cd /path/to/project/data && node sync_notion_to_core.js
```

---

## 📋 **새로운 브랜치에서의 활용**

### **1. 브랜치 생성 시 필수 작업**

#### **동기화 스크립트 복사**
```bash
# 새 브랜치에서
git checkout -b new-feature-branch
cp data/sync_notion_to_core.js data/
cp data/verify_data_match.js data/
cp data/notion_converter.js data/
cp data/complete_notion_fetch.js data/
```

#### **환경 설정**
```bash
# Notion API 설정 확인
# .env 파일 또는 환경변수 설정
NOTION_API_KEY=your_api_key
NOTION_DATABASE_ID=your_database_id
```

### **2. 개발 중 데이터 동기화**

#### **데이터 수정 후 동기화**
```bash
# 1. 노션에서 데이터 수정
# 2. 동기화 실행
cd data
node sync_notion_to_core.js

# 3. 검증
node verify_data_match.js

# 4. 애플리케이션 테스트
# 브라우저에서 새로고침하여 최신 데이터 확인
```

### **3. 브랜치 병합 전 검증**

#### **최종 동기화 및 검증**
```bash
# 브랜치 병합 전
cd data
node sync_notion_to_core.js
node verify_data_match.js

# 모든 검증 통과 후 병합
git add .
git commit -m "데이터 동기화 완료"
git push origin feature-branch
```

---

## 🎯 **결론**

### **핵심 포인트**
1. **단일 소스 원칙**: 노션 데이터베이스가 유일한 원본
2. **자동화된 동기화**: 수동 작업 없이 자동으로 동기화
3. **완전한 검증**: 동기화 후 반드시 검증 실행
4. **표준화된 프로세스**: 모든 브랜치에서 동일한 방식 사용

### **사용 시나리오**
- **데이터 수정**: 노션에서 데이터 수정 → 동기화 실행
- **새 브랜치**: 동기화 스크립트 복사 → 환경 설정 → 개발
- **병합 전**: 최종 동기화 → 검증 → 병합

### **유지보수**
- **정기적 검증**: 주 1회 검증 실행 권장
- **로그 모니터링**: 동기화 실패 시 로그 확인
- **백업**: 중요한 변경 전 데이터 백업

---

**작성 완료일**: 2025년 9월 14일  
**다음 검토 예정일**: 조대표님 검토 후  
**관련 문서**: 042번 데이터 소스 관리방안, 043번 단일소스 시스템 구성 보고서, 045번 4단계 개인검색 기능 완료 보고서
