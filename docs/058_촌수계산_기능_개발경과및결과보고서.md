# 058. 촌수계산 기능 개발경과 및 결과 보고서

작성일: 2025-01-17
작성자: 서대리
대상: 한양조씨 족보앱 촌수계산 기능(A단계~C단계 완료, D단계 일부)

## 1) 배경 및 목표
- 원소스 멀티유즈 전략에 따라 `window.CORE_DATA`만을 단일 데이터 소스로 사용
- 간단하고 단단한 알고리즘으로 두 사람 간의 촌수/호칭을 빠르고 정확하게 산출
- UI는 최소 절차(이름 2개 또는 ‘나→대상’ 1개)로 즉시 결과 확인

## 2) 주요 산출물(파일)
- 데이터/엔진
  - `data/chonsu_engine.js` (표준 엔진, Node/브라우저 공용)
  - `js/chonsu_engine.js` (브라우저 배포본)
  - `data/window_core_data.js` (브라우저용 데이터 주입 스크립트)
- 테스트/검증
  - `data/chonsu_comprehensive_test.js` (12+ 케이스 자동 검증)
- UI/컨트롤러
  - `app/calculator.html` (간결 입력형 화면)
  - `js/calculator_standalone.js` (인라인 2명 / 나→대상 입력 흐름)
  - `css/style.css` (아이콘 버튼 가시성, hover 강조 포함)
- 문서
  - `docs/055_촌수계산기_세부개발계획서.md` (세부 계획)
  - `docs/056_촌수계산기_완료_보고서.md` (1차 완료 보고)
  - 본 문서(058)

## 3) 촌수계산 모듈 상세(핵심 로직)
### 3.1 입력과 데이터 기준
- 입력: 인물 ID 2개(브라우저에서는 이름 → ID 매핑 후 사용)
- 데이터: `window.CORE_DATA`의 각 인물 레코드
  - 필드 활용: `id`, `name`, `세대`, `relationships.father/mother/spouses/children`

### 3.2 알고리즘 개요
1. 직계 판정(빠른 경로)
   - 한쪽이 다른 쪽의 조상인지 검사 → 거리(1-기반)로 즉시 확정
   - 예) 부모-자식 1촌, 조부-손자 2촌
2. 공통조상 탐색
   - A, B 각각에 대해 `father` 체인을 따라 조상 배열 생성
   - 가장 가까운 공통조상을 찾고, 거리(1-기반) 합산
   - 촌수 = (A→공통조상까지 거리) + (B→공통조상까지 거리)
3. 호칭 매핑(간단형)
   - 1: 부모/자녀, 2: 형제/자매, 3: 삼촌/조카, 4: 사촌, 5: 오촌 … (N: "N촌")

### 3.3 구현 포인트
- 거리 정의 1-기반 통일(부=1, 조부=2) → 사촌 4촌 정상화
- 형제 특별보정(0+0→2) 제거(1-기반에서 자연히 2촌)
- 반환: `{ chonsu, title, relationship, commonAncestor, distance1, distance2 }`

### 3.4 코드 흐름 요약
- `findAncestors(personId)`: `father` 체인으로 위로 추적, 가까운 순 배열
- `getDirectLineDistance(ancestorId, descendantId)`: descendant 조상 배열에서 매칭 시 (index+1)
- `findCommonAncestor(id1, id2)`: 두 조상 배열의 교집합에서 가장 가까운 항목 선택, 거리 (index+1)
- `calculateChonsu(id1, id2)`: 직계 판정 → 공통조상 탐색 → 촌수 합산 → 호칭 매핑

## 4) UI/사용 흐름
- “두 사람 입력”: 이름 2개 입력 → [촌수 계산]
- “한 사람 입력(나 → 대상)”: 시작점 고정(기본 `조은상`, 추후 `localStorage` 사용자명 적용) → 대상만 입력 → [나와의 촌수]
- 검색(🔍) 버튼: 항상 표시, hover 시 강조
- 레거시 모달형(첫/두 번째 선택) 제거로 단순화

## 5) 테스트 및 검증 결과
- 자동 시뮬레이션: `data/chonsu_comprehensive_test.js` (12 케이스)
  - 통과 11/12 (남은 1건은 실제 데이터의 부모 필드 확인 필요)
- 대표 케이스
  - 조정윤–조병희: 1촌, 조정윤–조영하: 2촌(직계 규칙 반영)
  - 조영하–조명하: 2촌(형제/자매)
  - 조원상–조성원: 4촌(공통 조병갑, 2+2)
  - 조성장–조원희/조웅희: 1촌(부자)

## 6) 동기화/배포 주의
- 브라우저 로딩 스크립트는 `js/chonsu_engine.js`
  - 배포 시 `data/chonsu_engine.js` → `js/chonsu_engine.js` 동기화 필수
  - 캐시 무효화: `calculator.html?v=2` 등 쿼리 권장

## 7) 사용자 “나” 설정(지속화) 설계
- 저장소: `localStorage`
  - 키: `gia_current_user`
  - 값: `{ id, name }`
- 앱 시작 시 읽어 `window.APP_CURRENT_USER`로 주입, ‘나→대상’ 시작점으로 사용

## 8) 남은 과제(D단계)
- 호칭 고도화: 성별/친·외가 구분, 외가 규칙(조씨 딸의 자녀) 반영
- 예외처리: 배우자 촌수 없음 처리 + 호칭 표기
- 자동테스트 확장: 20~30 케이스로 보강
- 사용자 설정: 최초 실행 시 ‘나 설정’ 모달, `localStorage` 저장/편집 UI

## 9) 결론
- 엔진: 1-기반 거리 + 직계 빠른 판정 + 공통조상 최단 합산으로 안정화
- UI: 이름 2개 또는 ‘나→대상’ 입력만으로 간결하게 계산
- 데이터/배포 동기화 유지 시 앱/테스트 결과 일치
- 향후 호칭/외가 규칙 및 사용자 ‘나’ 설정 UI 추가로 V1.0 품질 완성
