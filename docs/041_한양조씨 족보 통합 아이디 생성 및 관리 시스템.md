# í•œì–‘ì¡°ì”¨ ì¡±ë³´ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ

**ì‘ì„±ì¼**: 2025.01.14 16:00 KST  
**ì‘ì„±ì**: ë…¸íŒ€ì¥  
**ëŒ€ìƒ**: ì„œëŒ€ë¦¬ (Cursor AI)  
**ëª©ì **: ID ìƒì„±ë¶€í„° ì‹ ê·œ êµ¬ì„±ì› ì¶”ê°€ê¹Œì§€ í†µí•© ê´€ë¦¬

## ğŸ“‹ í†µí•© ì‹œìŠ¤í…œ ê°œìš”

ì´ ëª¨ë“ˆ í•˜ë‚˜ë¡œ ëª¨ë“  ì¡±ë³´ ê´€ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤:
1. **ê¸°ì¡´ 114ëª… ID ì¼ê´„ ìƒì„±**
2. **ID ê·œì¹™ ë° ê²€ì¦**  
3. **ì‹ ê·œ êµ¬ì„±ì› ìë™ ì¶”ê°€**
4. **ìì—°ì–´ ëª…ë ¹ ì²˜ë¦¬**
5. **ë°ì´í„° ë¬´ê²°ì„± ê´€ë¦¬**

## ğŸ’» í†µí•© ì¡±ë³´ ê´€ë¦¬ ì‹œìŠ¤í…œ

### í•µì‹¬ í†µí•© í´ë˜ìŠ¤
```javascript
/**
 * í•œì–‘ì¡°ì”¨ ì¡±ë³´ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ
 * - ID ìƒì„±, ê¸°ì¡´ ë°ì´í„° ì²˜ë¦¬, ì‹ ê·œ êµ¬ì„±ì› ì¶”ê°€ë¥¼ ëª¨ë‘ ì²˜ë¦¬
 */
class CompleteFamilySystem {
    constructor() {
        this.members = new Map();           // ID -> êµ¬ì„±ì› ì •ë³´
        this.counters = {};                 // ì¹´í…Œê³ ë¦¬ë³„ ìˆœë²ˆ ì¹´ìš´í„°
        this.changes = [];                  // ë³€ê²½ ì´ë ¥
        this.nameIndex = new Map();         // ì´ë¦„ -> ID ë§¤í•‘ (ë™ëª…ì´ì¸ ì²˜ë¦¬)
        
        console.log('ğŸ  í•œì–‘ì¡°ì”¨ ì¡±ë³´ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
    }
    
    // ========================================
    // 1. ID ìƒì„± ê·œì¹™ ë° ê¸°ë³¸ í•¨ìˆ˜
    // ========================================
    
    /**
     * ê°œì¸ ID ìƒì„±
     * @param {string} name - ì´ë¦„
     * @param {number} generation - ì„¸ëŒ€ (1-6)
     * @param {string} line - Line (LC/L1/L2/L3)  
     * @param {string} gender - ì„±ë³„ (M/F)
     * @param {string} relationship - ê´€ê³„ (son/wife/daughter/husband)
     * @returns {string} ìƒì„±ëœ ID
     */
    generateId(name, generation, line, gender, relationship) {
        // ê´€ê³„ ì½”ë“œ ë§¤í•‘
        const relationshipMap = {
            'son': 'SM',     // ì¡°ì”¨ ì•„ë“¤
            'wife': 'WF',    // ë©°ëŠë¦¬  
            'daughter': 'DF', // ì¡°ì”¨ ë”¸
            'husband': 'HM'   // ì‚¬ìœ„
        };
        
        // ì…ë ¥ê°’ ê²€ì¦
        const validLines = ['LC', 'L1', 'L2', 'L3'];
        if (!validLines.includes(line)) {
            throw new Error(`âŒ ì˜ëª»ëœ Line: ${line}. ì‚¬ìš© ê°€ëŠ¥: ${validLines.join(', ')}`);
        }
        
        if (generation < 1 || generation > 10) {
            throw new Error(`âŒ ì˜ëª»ëœ ì„¸ëŒ€: ${generation}. ë²”ìœ„: 1-10`);
        }
        
        // ì„¸ëŒ€ ì½”ë“œ
        const genCode = `G${generation}`;
        
        // ê´€ê³„ ì½”ë“œ
        const relCode = relationshipMap[relationship.toLowerCase()];
        if (!relCode) {
            throw new Error(`âŒ ì˜ëª»ëœ ê´€ê³„: ${relationship}. ì‚¬ìš© ê°€ëŠ¥: ${Object.keys(relationshipMap).join(', ')}`);
        }
        
        // ì¹´í…Œê³ ë¦¬ í‚¤ ìƒì„± (ìˆœë²ˆ ì¹´ìš´í„°ìš©)
        const categoryKey = `${line}-${genCode}-${relCode}`;
        
        // ìˆœë²ˆ ì¦ê°€
        if (!this.counters[categoryKey]) {
            this.counters[categoryKey] = 0;
        }
        this.counters[categoryKey]++;
        
        // ìˆœë²ˆì„ 3ìë¦¬ë¡œ í¬ë§·
        const sequence = this.counters[categoryKey].toString().padStart(3, '0');
        
        // ìµœì¢… ID ìƒì„±
        const id = `${line}-${genCode}-${relCode}-${sequence}`;
        
        console.log(`âœ… ID ìƒì„±: ${name} â†’ ${id}`);
        return id;
    }
    
    /**
     * ID íŒŒì‹±
     */
    parseId(id) {
        const parts = id.split('-');
        if (parts.length !== 4) {
            throw new Error(`âŒ ì˜ëª»ëœ ID í˜•ì‹: ${id}`);
        }
        
        const [line, generation, relationship, sequence] = parts;
        
        const relationshipName = {
            'SM': 'ì¡°ì”¨ ì•„ë“¤',
            'WF': 'ë©°ëŠë¦¬',
            'DF': 'ì¡°ì”¨ ë”¸', 
            'HM': 'ì‚¬ìœ„'
        };
        
        return {
            line: line,
            generation: parseInt(generation.replace('G', '')),
            relationship: relationship,
            relationshipName: relationshipName[relationship],
            sequence: parseInt(sequence),
            isJoFamily: ['SM', 'DF'].includes(relationship) // ì¡°ì”¨ í˜ˆí†µ ì—¬ë¶€
        };
    }
    
    /**
     * ë°°ìš°ì ID ì°¾ê¸°
     */
    findSpouseIdPattern(personId) {
        const parts = personId.split('-');
        if (parts.length !== 4) return null;
        
        const [line, gen, rel, seq] = parts;
        
        // ë°°ìš°ì ê´€ê³„ ì½”ë“œ ë§¤í•‘
        const spouseMap = {
            'SM': 'WF', // ì¡°ì”¨ ë‚¨ì â†’ ë©°ëŠë¦¬
            'WF': 'SM', // ë©°ëŠë¦¬ â†’ ì¡°ì”¨ ë‚¨ì  
            'DF': 'HM', // ì¡°ì”¨ ë”¸ â†’ ì‚¬ìœ„
            'HM': 'DF'  // ì‚¬ìœ„ â†’ ì¡°ì”¨ ë”¸
        };
        
        const spouseRel = spouseMap[rel];
        return spouseRel ? `${line}-${gen}-${spouseRel}-${seq}` : null;
    }
    
    // ========================================
    // 2. ê¸°ì¡´ ë°ì´í„° ì²˜ë¦¬ (114ëª… ì¼ê´„ ì ìš©)
    // ========================================
    
    /**
     * ê¸°ì¡´ ë…¸ì…˜ ë°ì´í„°ì— ID ì¼ê´„ ìƒì„± ë° ì ìš©
     * @param {Array} notionData - ë…¸ì…˜ì—ì„œ ê°€ì ¸ì˜¨ ì›ë³¸ ë°ì´í„°
     * @returns {Array} IDê°€ ë¶€ì—¬ëœ ì™„ì „í•œ ë°ì´í„°
     */
    applyIdsToExistingData(notionData) {
        console.log(`ğŸ”„ ê¸°ì¡´ ë°ì´í„° ${notionData.length}ëª… ID ìƒì„± ì‹œì‘...`);
        
        const results = [];
        let successCount = 0;
        let errorCount = 0;
        
        // ì„¸ëŒ€ìˆœìœ¼ë¡œ ì •ë ¬ (1ì„¸ëŒ€ë¶€í„° ì²˜ë¦¬)
        const sortedData = notionData.sort((a, b) => a.ì„¸ëŒ€ - b.ì„¸ëŒ€);
        
        sortedData.forEach((person, index) => {
            try {
                const line = this.determinePersonLine(person);
                const relationship = this.determineRelationship(person);
                const gender = person.ì„±ë³„ || this.determineGender(person.ì´ë¦„);
                
                const id = this.generateId(
                    person.ì´ë¦„,
                    person.ì„¸ëŒ€,
                    line,
                    gender,
                    relationship
                );
                
                // ì™„ì „í•œ êµ¬ì„±ì› ì •ë³´ ìƒì„±
                const completeMember = {
                    id: id,
                    name: person.ì´ë¦„,
                    gender: gender,
                    generation: person.ì„¸ëŒ€,
                    line: line,
                    relationship: relationship,
                    birthYear: person.ìƒë…„ || null,
                    status: this.determineStatus(person),
                    deathYear: person.ì‚¬ë§ì¼ || null,
                    fatherName: person.ì•„ë²„ì§€ || null,
                    motherName: person.ì–´ë¨¸ë‹ˆ || null,
                    spouseName: person.ë°°ìš°ì || null,
                    children: [],
                    phone: person.ì—°ë½ì²˜ || '',
                    address: person.ì£¼ì†Œ || '',
                    job: person.ì§ì—… || '',
                    notes: person.ë¹„ê³  || '',
                    originalData: person, // ì›ë³¸ ë°ì´í„° ë³´ì¡´
                    createdAt: new Date().toISOString()
                };
                
                // ë©”ëª¨ë¦¬ì— ì €ì¥
                this.members.set(id, completeMember);
                
                // ì´ë¦„ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸ (ë™ëª…ì´ì¸ ì²˜ë¦¬ìš©)
                this.updateNameIndex(completeMember.name, id);
                
                results.push(completeMember);
                successCount++;
                
            } catch (error) {
                console.error(`âŒ ID ìƒì„± ì‹¤íŒ¨ - ${person.ì´ë¦„}:`, error.message);
                errorCount++;
                
                // ì˜¤ë¥˜ ì •ë³´ë„ ê²°ê³¼ì— í¬í•¨
                results.push({
                    ...person,
                    id: null,
                    error: error.message
                });
            }
        });
        
        console.log(`âœ… ê¸°ì¡´ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ: ì„±ê³µ ${successCount}ëª…, ì‹¤íŒ¨ ${errorCount}ëª…`);
        
        // ê°€ì¡± ê´€ê³„ ì—°ê²° (ë¶€ëª¨-ìë…€, ë°°ìš°ì ê´€ê³„)
        this.linkFamilyRelationships();
        
        return results;
    }
    
    /**
     * Line ê²°ì • ë¡œì§
     */
    determinePersonLine(person) {
        if (person.ì„¸ëŒ€ <= 2) return 'LC';
        
        // Line ì •ë³´ê°€ ìˆëŠ” ê²½ìš°
        if (person.Line) {
            if (person.Line === 'Line1') return 'L1';
            if (person.Line === 'Line2') return 'L2';  
            if (person.Line === 'Line3') return 'L3';
        }
        
        // Line ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° ë¶€ëª¨ë¥¼ í†µí•´ ì¶”ì •
        return this.inferLineFromParents(person);
    }
    
    /**
     * ê´€ê³„ ê²°ì • ë¡œì§  
     */
    determineRelationship(person) {
        const name = person.ì´ë¦„;
        const gender = person.ì„±ë³„ || this.determineGender(name);
        
        if (name.startsWith('ì¡°')) {
            return gender === 'M' ? 'son' : 'daughter';
        } else {
            return gender === 'F' ? 'wife' : 'husband';
        }
    }
    
    /**
     * ì„±ë³„ ìë™ ì¶”ë¡ 
     */
    determineGender(name) {
        return name.startsWith('ì¡°') ? 'M' : 'F';
    }
    
    /**
     * ìƒì¡´ ìƒíƒœ ê²°ì •
     */
    determineStatus(person) {
        if (person.ì‚¬ë§ì¼ || person.ìƒì¡´ìƒíƒœ === 'ê³ ì¸') return 'deceased';
        if (person.ì„¸ëŒ€ <= 2) return 'deceased'; // 1-2ì„¸ëŒ€ëŠ” ëŒ€ë¶€ë¶„ ê³ ì¸
        if (person.ì„¸ëŒ€ >= 5) return 'living';   // 5-6ì„¸ëŒ€ëŠ” ëŒ€ë¶€ë¶„ ìƒì¡´
        return person.ìƒì¡´ìƒíƒœ || 'unknown';
    }
    
    /**
     * ì´ë¦„ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸ (ë™ëª…ì´ì¸ ì²˜ë¦¬)
     */
    updateNameIndex(name, id) {
        if (!this.nameIndex.has(name)) {
            this.nameIndex.set(name, []);
        }
        this.nameIndex.get(name).push(id);
    }
    
    // ========================================
    // 3. ì‹ ê·œ êµ¬ì„±ì› ìë™ ì¶”ê°€
    // ========================================
    
    /**
     * ìì—°ì–´ ì…ë ¥ìœ¼ë¡œ ì‹ ê·œ êµ¬ì„±ì› ì¶”ê°€
     * @param {string} input - "ì¡°ëŒ€í•˜-í—ˆíš¨ìˆœ ì‚¬ì´ì— ì•„ë“¤ ì¡°ì„±ë¯¼ì´ íƒœì–´ë‚¬ìŠµë‹ˆë‹¤"
     * @returns {Object} ìƒì„±ëœ êµ¬ì„±ì› ì •ë³´
     */
    addNewMemberFromText(input) {
        console.log(`ğŸ”„ ìì—°ì–´ ì²˜ë¦¬: ${input}`);
        
        const parsed = this.parseNaturalLanguage(input);
        return this.addNewMember(
            parsed.name,
            parsed.fatherId, 
            parsed.motherId,
            parsed.gender,
            parsed.birthYear
        );
    }
    
    /**
     * êµ¬ì¡°í™”ëœ ì •ë³´ë¡œ ì‹ ê·œ êµ¬ì„±ì› ì¶”ê°€
     */
    addNewMember(name, fatherId, motherId, gender, birthYear = null) {
        // ë¶€ëª¨ ì •ë³´ ê²€ì¦
        const father = this.members.get(fatherId);
        const mother = this.members.get(motherId);
        
        if (!father || !mother) {
            throw new Error(`âŒ ë¶€ëª¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ì•„ë²„ì§€=${fatherId}, ì–´ë¨¸ë‹ˆ=${motherId}`);
        }
        
        console.log(`ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ë¶€ëª¨: ${father.name}(${fatherId}) + ${mother.name}(${motherId})`);
        
        // Lineê³¼ ì„¸ëŒ€ ìë™ ê³„ì‚°
        const line = this.calculateChildLine(father, mother);
        const generation = Math.max(father.generation, mother.generation) + 1;
        
        // ê´€ê³„ ê²°ì •
        const relationship = this.determineChildRelationship(name, gender);
        
        // ID ìƒì„±
        const id = this.generateId(name, generation, line, gender, relationship);
        
        // êµ¬ì„±ì› ì •ë³´ ìƒì„±
        const newMember = {
            id: id,
            name: name,
            gender: gender,
            generation: generation,
            line: line,
            relationship: relationship,
            birthYear: birthYear,
            status: 'living',
            fatherId: fatherId,
            motherId: motherId,
            children: [],
            phone: '',
            address: '',
            job: '',
            notes: `ìë™ ìƒì„± (${new Date().toLocaleDateString()})`,
            createdAt: new Date().toISOString()
        };
        
        // ë©”ëª¨ë¦¬ì— ì¶”ê°€
        this.members.set(id, newMember);
        this.updateNameIndex(name, id);
        
        // ë¶€ëª¨ì˜ ìë…€ ëª©ë¡ì— ì¶”ê°€
        father.children = father.children || [];
        mother.children = mother.children || [];
        father.children.push(id);
        mother.children.push(id);
        
        // ë³€ê²½ ë¡œê·¸ ê¸°ë¡
        this.changes.push({
            type: 'birth',
            member: newMember,
            parents: [father.name, mother.name],
            timestamp: new Date(),
            description: `${name} ì¶œìƒ (ë¶€ëª¨: ${father.name}-${mother.name})`
        });
        
        console.log(`âœ… ì‹ ê·œ êµ¬ì„±ì› ì¶”ê°€ ì™„ë£Œ: ${name} â†’ ${id}`);
        return newMember;
    }
    
    /**
     * ê²°í˜¼ ì •ë³´ ì¶”ê°€
     */
    addMarriage(personId, spouseName, spouseGender, marriageYear = null) {
        const person = this.members.get(personId);
        if (!person) {
            throw new Error(`âŒ ì‚¬ëŒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${personId}`);
        }
        
        // ë°°ìš°ì ê´€ê³„ ê²°ì •
        const spouseRelationship = person.relationship === 'son' ? 'wife' : 
                                 person.relationship === 'daughter' ? 'husband' : 'unknown';
        
        if (spouseRelationship === 'unknown') {
            throw new Error(`âŒ ${person.name}ì˜ ê²°í˜¼ ìƒëŒ€ ê´€ê³„ë¥¼ ê²°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
        }
        
        // ë°°ìš°ì ID ìƒì„±
        const spouseId = this.generateSpouseId(personId, spouseRelationship);
        
        // ë°°ìš°ì ì •ë³´ ìƒì„±
        const spouse = {
            id: spouseId,
            name: spouseName,
            gender: spouseGender,
            generation: person.generation,
            line: person.line,
            relationship: spouseRelationship,
            spouseId: personId,
            marriageYear: marriageYear,
            status: 'living',
            children: [],
            phone: '',
            address: '',
            job: '',
            notes: `ê²°í˜¼ (${marriageYear || 'ì—°ë„ë¯¸ìƒ'})`,
            createdAt: new Date().toISOString()
        };
        
        // ì–‘ìª½ ë°°ìš°ì ì •ë³´ ì—…ë°ì´íŠ¸
        person.spouseId = spouseId;
        person.marriageYear = marriageYear;
        
        this.members.set(spouseId, spouse);
        this.updateNameIndex(spouseName, spouseId);
        
        // ë³€ê²½ ë¡œê·¸ ê¸°ë¡
        this.changes.push({
            type: 'marriage',
            couple: [person.name, spouseName],
            timestamp: new Date(),
            description: `${person.name} â™¥ ${spouseName} ê²°í˜¼`
        });
        
        console.log(`ğŸ’’ ê²°í˜¼ ì¶”ê°€ ì™„ë£Œ: ${person.name} â™¥ ${spouseName}`);
        return spouse;
    }
    
    // ========================================
    // 4. í†µí•© ëª…ë ¹ì–´ ì²˜ë¦¬ ì¸í„°í˜ì´ìŠ¤
    // ========================================
    
    /**
     * ìì—°ì–´ ëª…ë ¹ì–´ í†µí•© ì²˜ë¦¬
     * @param {string} command - ìì—°ì–´ ëª…ë ¹
     * @returns {Object} ì²˜ë¦¬ ê²°ê³¼
     */
    processCommand(command) {
        const cmd = command.toLowerCase().trim();
        
        console.log(`ğŸ¯ ëª…ë ¹ì–´ ì²˜ë¦¬: ${command}`);
        
        try {
            if (cmd.includes('íƒœì–´ë‚¬ìŠµë‹ˆë‹¤') || cmd.includes('ì¶œìƒ')) {
                return this.handleBirth(command);
            } else if (cmd.includes('ê²°í˜¼')) {
                return this.handleMarriage(command);
            } else if (cmd.includes('ì‚¬ë§') || cmd.includes('ë³„ì„¸')) {
                return this.handleDeath(command);
            } else if (cmd.includes('ê²€ìƒ‰') || cmd.includes('ì°¾ì•„')) {
                return this.handleSearch(command);
            } else if (cmd.includes('ëª©ë¡') || cmd.includes('ì „ì²´')) {
                return this.handleList(command);
            } else {
                return this.handleDirectInput(command);
            }
        } catch (error) {
            console.error('âŒ ëª…ë ¹ì–´ ì²˜ë¦¬ ì‹¤íŒ¨:', error.message);
            return {
                success: false,
                error: error.message,
                suggestion: this.getSuggestion(command)
            };
        }
    }
    
    /**
     * ì¶œìƒ ì²˜ë¦¬
     */
    handleBirth(command) {
        const newMember = this.addNewMemberFromText(command);
        
        return {
            success: true,
            type: 'birth',
            member: newMember,
            message: `ğŸ‰ ${newMember.name}(${newMember.id})ì´ ì¡±ë³´ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`,
            summary: {
                name: newMember.name,
                id: newMember.id,
                generation: `${newMember.generation}ì„¸ëŒ€`,
                line: newMember.line,
                parents: this.getParentNames(newMember)
            }
        };
    }
    
    /**
     * ê²€ìƒ‰ ì²˜ë¦¬
     */
    handleSearch(command) {
        const nameMatch = command.match(/([ê°€-í£]{2,4})/);
        if (!nameMatch) {
            throw new Error('ê²€ìƒ‰í•  ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        const searchName = nameMatch[1];
        const results = this.searchByName(searchName);
        
        return {
            success: true,
            type: 'search',
            query: searchName,
            results: results,
            message: `ğŸ” "${searchName}" ê²€ìƒ‰ ê²°ê³¼: ${results.length}ëª…`,
            hasMultiple: results.length > 1
        };
    }
    
    // ========================================
    // 5. ìœ í‹¸ë¦¬í‹° ë° ì¡°íšŒ í•¨ìˆ˜
    // ========================================
    
    /**
     * ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰ (ë™ëª…ì´ì¸ í¬í•¨)
     */
    searchByName(name) {
        const ids = this.nameIndex.get(name) || [];
        return ids.map(id => {
            const member = this.members.get(id);
            const parents = this.getParentNames(member);
            const spouse = member.spouseId ? this.members.get(member.spouseId) : null;
            
            return {
                ...member,
                parents: parents,
                spouseName: spouse ? spouse.name : null,
                displayName: `${member.name} (${member.generation}ì„¸ëŒ€, ${member.line})`
            };
        });
    }
    
    /**
     * ë¶€ëª¨ ì´ë¦„ ì¡°íšŒ
     */
    getParentNames(member) {
        const father = member.fatherId ? this.members.get(member.fatherId) : null;
        const mother = member.motherId ? this.members.get(member.motherId) : null;
        
        return {
            father: father ? father.name : member.fatherName || 'ë¯¸í™•ì¸',
            mother: mother ? mother.name : member.motherName || 'ë¯¸í™•ì¸'
        };
    }
    
    /**
     * ì „ì²´ êµ¬ì„±ì› ëª©ë¡ (ì •ë ¬ëœ)
     */
    getAllMembers() {
        return Array.from(this.members.values())
                   .sort((a, b) => a.id.localeCompare(b.id));
    }
    
    /**
     * ì„¸ëŒ€ë³„ êµ¬ì„±ì› ì¡°íšŒ
     */
    getMembersByGeneration(generation) {
        return Array.from(this.members.values())
                   .filter(member => member.generation === generation)
                   .sort((a, b) => a.id.localeCompare(b.id));
    }
    
    /**
     * Lineë³„ êµ¬ì„±ì› ì¡°íšŒ  
     */
    getMembersByLine(line) {
        return Array.from(this.members.values())
                   .filter(member => member.line === line)
                   .sort((a, b) => a.id.localeCompare(b.id));
    }
    
    /**
     * ë¶€ë¶€ ë‹¨ìœ„ ê·¸ë£¹í•‘
     */
    getCouples() {
        const couples = [];
        const processed = new Set();
        
        this.members.forEach((person, id) => {
            if (processed.has(id)) return;
            
            const spousePattern = this.findSpouseIdPattern(id);
            if (spousePattern && this.members.has(spousePattern)) {
                const spouse = this.members.get(spousePattern);
                
                couples.push({
                    husband: person.relationship === 'son' ? person : spouse,
                    wife: person.relationship === 'wife' ? person : spouse,
                    generation: person.generation,
                    line: person.line
                });
                
                processed.add(id);
                processed.add(spousePattern);
            }
        });
        
        return couples.sort((a, b) => a.husband.id.localeCompare(b.husband.id));
    }
    
    /**
     * ë³€ê²½ ì´ë ¥ ì¡°íšŒ
     */
    getChangeHistory(limit = 10) {
        return this.changes
                   .slice(-limit)
                   .reverse()
                   .map(change => ({
                       ...change,
                       timeAgo: this.getTimeAgo(change.timestamp)
                   }));
    }
    
    /**
     * í†µê³„ ì •ë³´
     */
    getStatistics() {
        const members = Array.from(this.members.values());
        
        const stats = {
            ì´ì¸ì›: members.length,
            ì„¸ëŒ€ë³„: {},
            Lineë³„: {},
            ìƒì¡´í˜„í™©: {},
            ì¡°ì”¨í˜ˆí†µ: 0,
            ìµœê·¼ë³€ê²½: this.changes.length
        };
        
        // ì„¸ëŒ€ë³„ í†µê³„
        for (let g = 1; g <= 6; g++) {
            stats.ì„¸ëŒ€ë³„[`${g}ì„¸ëŒ€`] = members.filter(m => m.generation === g).length;
        }
        
        // Lineë³„ í†µê³„
        ['LC', 'L1', 'L2', 'L3'].forEach(line => {
            stats.Lineë³„[line] = members.filter(m => m.line === line).length;
        });
        
        // ìƒì¡´ í˜„í™©
        ['living', 'deceased', 'unknown'].forEach(status => {
            stats.ìƒì¡´í˜„í™©[status] = members.filter(m => m.status === status).length;
        });
        
        // ì¡°ì”¨ í˜ˆí†µ
        stats.ì¡°ì”¨í˜ˆí†µ = members.filter(m => ['son', 'daughter'].includes(m.relationship)).length;
        
        return stats;
    }
    
    // ========================================
    // 6. ë‚´ë¶€ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // ========================================
    
    /**
     * ìì—°ì–´ íŒŒì‹±
     */
    parseNaturalLanguage(input) {
        const patterns = [
            {
                regex: /(\w+)-(\w+)\s*ì‚¬ì´ì—\s*(ì•„ë“¤|ë”¸)\s*(\w+).*?(\d{4})?/,
                extract: (match) => ({
                    fatherName: match[1],
                    motherName: match[2], 
                    genderText: match[3],
                    name: match[4],
                    gender: match[3] === 'ì•„ë“¤' ? 'M' : 'F',
                    birthYear: match[5] ? parseInt(match[5]) : null
                })
            },
            {
                regex: /(\w+)\((ë‚¨|ì—¬|ì•„ë“¤|ë”¸),\s*(\w+)-(\w+)\)/,
                extract: (match) => ({
                    name: match[1],
                    gender: ['ë‚¨', 'ì•„ë“¤'].includes(match[2]) ? 'M' : 'F',
                    fatherName: match[3],
                    motherName: match[4]
                })
            }
        ];
        
        for (let pattern of patterns) {
            const match = input.match(pattern.regex);
            if (match) {
                const extracted = pattern.extract(match);
                
                const fatherId = this.findPersonByName(extracted.fatherName);
                const motherId = this.findPersonByName(extracted.motherName);
                
                return {
                    name: extracted.name,
                    fatherId: fatherId,
                    motherId: motherId,
                    gender: extracted.gender,
                    birthYear: extracted.birthYear
                };
            }
        }
        
        throw new Error(`âŒ íŒŒì‹±í•  ìˆ˜ ì—†ëŠ” ì…ë ¥: ${input}\nğŸ’¡ ì˜ˆì‹œ: "ì¡°ëŒ€í•˜-í—ˆíš¨ìˆœ ì‚¬ì´ì— ì•„ë“¤ ì¡°ì„±ë¯¼ì´ íƒœì–´ë‚¬ìŠµë‹ˆë‹¤"`);
    }
    
    /**
     * ì´ë¦„ìœ¼ë¡œ ì‚¬ëŒ ì°¾ê¸° (ë™ëª…ì´ì¸ ì²˜ë¦¬)
     */
    findPersonByName(name) {
        const ids = this.nameIndex.get(name);
        if (!ids || ids.length === 0) {
            throw new Error(`âŒ ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${name}`);
        }
        
        if (ids.length === 1) {
            return ids[0];
        }
        
        // ë™ëª…ì´ì¸ì¸ ê²½ìš° - ê°€ì¥ ë†’ì€ ì„¸ëŒ€ ìš°ì„ 
        const candidates = ids.map(id => this.members.get(id))
                              .sort((a, b) => a.generation - b.generation);
        
        console.log(`âš ï¸  ë™ëª…ì´ì¸ ë°œê²¬ "${name}": ${candidates.length}ëª…. ìµœìƒìœ„ ì„¸ëŒ€(${candidates[0].generation}ì„¸ëŒ€) ì„ íƒ`);
        return candidates[0].id;
    }
    
    getTimeAgo(timestamp) {
        const minutes = Math.floor((new Date() - timestamp) / 60000);
        if (minutes < 1) return 'ë°©ê¸ˆ ì „';
        if (minutes < 60) return `${minutes}ë¶„ ì „`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}ì‹œê°„ ì „`;
        const days = Math.floor(hours / 24);
        return `${days}ì¼ ì „`;
    }
    
    calculateChildLine(father, mother) {
        return father.name.startsWith('ì¡°') ? father.line : mother.line;
    }
    
    determineChildRelationship(name, gender) {
        return name.startsWith('ì¡°') ? 
               (gender === 'M' ? 'son' : 'daughter') : 
               (gender === 'M' ? 'husband' : 'wife');
    }
    
    generateSpouseId(personId, spouseRelationship) {
        const parsed = this.parseId(personId);
        const relationCode = spouseRelationship === 'wife' ? 'WF' : 'HM';
        return `${parsed.line}-G${parsed.generation}-${relationCode}-${parsed.sequence.toString().padStart(3, '0')}`;
    }
    
    linkFamilyRelationships() {
        // TODO: ë¶€ëª¨-ìë…€ ê´€ê³„ ìë™ ì—°ê²° ë¡œì§
        console.log('ğŸ”— ê°€ì¡± ê´€ê³„ ì—°ê²° ì‘ì—… ì‹œì‘...');
    }
    
    inferLineFromParents(person) {
        // TODO: ë¶€ëª¨ ì •ë³´ë¡œë¶€í„° Line ì¶”ì • ë¡œì§
        return 'L1'; // ê¸°ë³¸ê°’
    }
    
    getSuggestion(command) {
        return [
            "ğŸ’¡ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:",
            "â€¢ 'ì¡°ëŒ€í•˜-í—ˆíš¨ìˆœ ì‚¬ì´ì— ì•„ë“¤ ì¡°ì„±ë¯¼ì´ íƒœì–´ë‚¬ìŠµë‹ˆë‹¤'",
            "â€¢ 'ì¡°ì„±ë¯¼ì´ ê¹€ë¯¸ì˜ê³¼ ê²°í˜¼í–ˆìŠµë‹ˆë‹¤'",
            "â€¢ 'ì¡°ê´‘í¬ ê²€ìƒ‰í•´ì¤˜'",
            "â€¢ 'ì „ì²´ ëª©ë¡ ë³´ì—¬ì¤˜'",
            "â€¢ '3ì„¸ëŒ€ ëª©ë¡ ë³´ì—¬ì¤˜'"
        ];
    }
}

// ========================================
// 7. ì‚¬ìš© ì˜ˆì‹œ ë° í…ŒìŠ¤íŠ¸ ì½”ë“œ
// ========================================

/**
 * ì‹¤ì œ ì‚¬ìš© ì˜ˆì‹œ
 */
function demonstrateSystem() {
    console.log('ğŸš€ í•œì–‘ì¡°ì”¨ ì¡±ë³´ ì‹œìŠ¤í…œ ë°ëª¨ ì‹œì‘');
    
    // ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    const familySystem = new CompleteFamilySystem();
    
    // 1. ê¸°ì¡´ ë…¸ì…˜ ë°ì´í„° ì˜ˆì‹œ (ì‹¤ì œë¡œëŠ” 114ëª…)
    const sampleNotionData = [
        {
            ì´ë¦„: 'ì¡°ì •ìœ¤',
            ì„¸ëŒ€: 1,
            Line: 'Common',
            ì„±ë³„: 'M',
            ìƒë…„: 1852,
            ìƒì¡´ìƒíƒœ: 'ê³ ì¸',
            ì‚¬ë§ì¼: 1940,
            ë°°ìš°ì: 'ì„ì •ìˆ™,ì´ì²œê²½',
            ë¹„ê³ : 'ì‹œì¡°'
        },
        {
            ì´ë¦„: 'ì„ì •ìˆ™',
            ì„¸ëŒ€: 1,
            Line: 'Common',
            ì„±ë³„: 'F',
            ìƒë…„: 1855,
            ìƒì¡´ìƒíƒœ: 'ê³ ì¸',
            ë°°ìš°ì: 'ì¡°ì •ìœ¤',
            ë¹„ê³ : 'ì¡°ì •ìœ¤ ì²«ì§¸ ë¶€ì¸'
        },
        {
            ì´ë¦„: 'ì¡°ëŒ€í•˜',
            ì„¸ëŒ€: 3,
            Line: 'Line1',
            ì„±ë³„: 'M',
            ìƒë…„: 1920,
            ìƒì¡´ìƒíƒœ: 'ìƒì¡´',
            ë°°ìš°ì: 'í—ˆíš¨ìˆœ',
            ì•„ë²„ì§€: 'ì¡°ë³‘í¬',
            ì–´ë¨¸ë‹ˆ: 'ê°•ë¶€ì¸'
        },
        {
            ì´ë¦„: 'í—ˆíš¨ìˆœ',
            ì„¸ëŒ€: 3,
            Line: 'Line1',
            ì„±ë³„: 'F',
            ìƒë…„: 1925,
            ìƒì¡´ìƒíƒœ: 'ìƒì¡´',
            ë°°ìš°ì: 'ì¡°ëŒ€í•˜'
        }
    ];
    
    // 2. ê¸°ì¡´ ë°ì´í„°ì— ID ì ìš©
    console.log('\nğŸ“‹ 1ë‹¨ê³„: ê¸°ì¡´ ë°ì´í„° ID ìƒì„±');
    const processedData = familySystem.applyIdsToExistingData(sampleNotionData);
    
    processedData.forEach(member => {
        if (member.id) {
            console.log(`âœ… ${member.name}: ${member.id}`);
        } else {
            console.log(`âŒ ${member.name}: ìƒì„± ì‹¤íŒ¨ - ${member.error}`);
        }
    });
    
    // 3. ì‹ ê·œ êµ¬ì„±ì› ìë™ ì¶”ê°€
    console.log('\nğŸ‘¶ 2ë‹¨ê³„: ì‹ ê·œ êµ¬ì„±ì› ì¶”ê°€');
    
    try {
        // ìì—°ì–´ë¡œ ìë…€ ì¶”ê°€
        const result1 = familySystem.processCommand(
            "ì¡°ëŒ€í•˜-í—ˆíš¨ìˆœ ì‚¬ì´ì— ì•„ë“¤ ì¡°ì„±ë¯¼ì´ 2010ë…„ì— íƒœì–´ë‚¬ìŠµë‹ˆë‹¤"
        );
        console.log('ê²°ê³¼1:', result1.message);
        
        // ë”¸ ì¶”ê°€
        const result2 = familySystem.processCommand(
            "ì¡°ëŒ€í•˜-í—ˆíš¨ìˆœ ì‚¬ì´ì— ë”¸ ì¡°ì„±í¬ê°€ 2012ë…„ì— íƒœì–´ë‚¬ìŠµë‹ˆë‹¤"
        );
        console.log('ê²°ê³¼2:', result2.message);
        
        // ê²°í˜¼ ì¶”ê°€
        const result3 = familySystem.processCommand(
            "ì¡°ì„±ë¯¼ì´ ê¹€ë¯¸ì˜ê³¼ 2035ë…„ì— ê²°í˜¼í–ˆìŠµë‹ˆë‹¤"
        );
        console.log('ê²°ê³¼3:', result3.message);
        
    } catch (error) {
        console.error('âŒ ì‹ ê·œ ì¶”ê°€ ì‹¤íŒ¨:', error.message);
    }
    
    // 4. ê²€ìƒ‰ ê¸°ëŠ¥
    console.log('\nğŸ” 3ë‹¨ê³„: ê²€ìƒ‰ ê¸°ëŠ¥');
    const searchResult = familySystem.processCommand("ì¡°ëŒ€í•˜ ê²€ìƒ‰í•´ì¤˜");
    console.log('ê²€ìƒ‰ ê²°ê³¼:', searchResult);
    
    // 5. í†µê³„ ì •ë³´
    console.log('\nğŸ“Š 4ë‹¨ê³„: í†µê³„ ì •ë³´');
    const stats = familySystem.getStatistics();
    console.log('ì¡±ë³´ í†µê³„:', stats);
    
    // 6. ë³€ê²½ ì´ë ¥
    console.log('\nğŸ“ 5ë‹¨ê³„: ë³€ê²½ ì´ë ¥');
    const history = familySystem.getChangeHistory();
    history.forEach(change => {
        console.log(`${change.timeAgo}: ${change.description}`);
    });
    
    console.log('\nâœ… ë°ëª¨ ì™„ë£Œ!');
    return familySystem;
}

// ========================================
// 8. ì„œëŒ€ë¦¬ìš© í€µ ê°€ì´ë“œ
// ========================================

/**
 * ì„œëŒ€ë¦¬ìš© ë‹¨ê³„ë³„ ì‚¬ìš© ê°€ì´ë“œ
 */
function quickStartGuide() {
    console.log(`
ğŸ¯ ì„œëŒ€ë¦¬ìš© ì¡±ë³´ ì‹œìŠ¤í…œ ì‚¬ìš©ë²•

1ï¸âƒ£ ì‹œìŠ¤í…œ ì´ˆê¸°í™”:
   const family = new CompleteFamilySystem();

2ï¸âƒ£ ê¸°ì¡´ 114ëª… ë°ì´í„° ì²˜ë¦¬:
   const result = family.applyIdsToExistingData(notionData);

3ï¸âƒ£ ì‹ ê·œ êµ¬ì„±ì› ì¶”ê°€:
   family.processCommand("ì¡°ëŒ€í•˜-í—ˆíš¨ìˆœ ì‚¬ì´ì— ì•„ë“¤ ì¡°ì„±ë¯¼ì´ íƒœì–´ë‚¬ìŠµë‹ˆë‹¤");

4ï¸âƒ£ ê²€ìƒ‰í•˜ê¸°:
   family.processCommand("ì¡°ìœ¤í¬ ê²€ìƒ‰í•´ì¤˜");

5ï¸âƒ£ í†µê³„ ë³´ê¸°:
   const stats = family.getStatistics();

6ï¸âƒ£ ëª¨ë“  êµ¬ì„±ì› ë³´ê¸°:
   const all = family.getAllMembers();

ğŸ”§ ì£¼ìš” ë©”ì„œë“œ:
â€¢ generateId() - ID ìƒì„±
â€¢ addNewMember() - ì‹ ê·œ êµ¬ì„±ì› ì¶”ê°€  
â€¢ searchByName() - ì´ë¦„ ê²€ìƒ‰
â€¢ getCouples() - ë¶€ë¶€ ë‹¨ìœ„ ì¡°íšŒ
â€¢ getChangeHistory() - ë³€ê²½ ì´ë ¥
â€¢ getStatistics() - í†µê³„ ì •ë³´

ğŸ’¡ ID í˜•ì‹: L1-G3-SM-001
   L1(Line) G3(ì„¸ëŒ€) SM(ê´€ê³„) 001(ìˆœë²ˆ)
`);
}

// ========================================
// 9. ì—ëŸ¬ ì²˜ë¦¬ ë° ê²€ì¦
// ========================================

/**
 * ì‹œìŠ¤í…œ ê²€ì¦ í•¨ìˆ˜
 */
function validateSystem(familySystem) {
    console.log('ğŸ” ì‹œìŠ¤í…œ ê²€ì¦ ì‹œì‘...');
    
    const issues = [];
    
    // ID ì¤‘ë³µ ê²€ì‚¬
    const allIds = Array.from(familySystem.members.keys());
    const uniqueIds = new Set(allIds);
    if (allIds.length !== uniqueIds.size) {
        issues.push('âŒ ID ì¤‘ë³µ ë°œê²¬');
    }
    
    // ë¶€ë¶€ ë§¤ì¹­ ê²€ì‚¬
    familySystem.members.forEach((member, id) => {
        if (member.spouseId) {
            const spouse = familySystem.members.get(member.spouseId);
            if (!spouse || spouse.spouseId !== id) {
                issues.push(`âŒ ë¶€ë¶€ ë§¤ì¹­ ì˜¤ë¥˜: ${member.name}(${id})`);
            }
        }
    });
    
    // ë¶€ëª¨-ìë…€ ê´€ê³„ ê²€ì‚¬
    familySystem.members.forEach((member, id) => {
        if (member.fatherId) {
            const father = familySystem.members.get(member.fatherId);
            if (!father) {
                issues.push(`âŒ ì•„ë²„ì§€ ID ì˜¤ë¥˜: ${member.name} â†’ ${member.fatherId}`);
            }
        }
    });
    
    if (issues.length === 0) {
        console.log('âœ… ì‹œìŠ¤í…œ ê²€ì¦ í†µê³¼!');
    } else {
        console.log('âš ï¸ ê²€ì¦ ì´ìŠˆ:');
        issues.forEach(issue => console.log(issue));
    }
    
    return issues.length === 0;
}

// ========================================
// 10. ë‚´ë³´ë‚´ê¸° ë° ë°±ì—…
// ========================================

/**
 * JSON ë°ì´í„° ë‚´ë³´ë‚´ê¸°
 */
function exportToJSON(familySystem) {
    const exportData = {
        version: "1.0",
        exportDate: new Date().toISOString(),
        totalMembers: familySystem.members.size,
        members: Array.from(familySystem.members.values()),
        statistics: familySystem.getStatistics(),
        changeHistory: familySystem.getChangeHistory(100)
    };
    
    return JSON.stringify(exportData, null, 2);
}

/**
 * CSV í˜•íƒœë¡œ ë‚´ë³´ë‚´ê¸°
 */
function exportToCSV(familySystem) {
    const members = familySystem.getAllMembers();
    const headers = [
        'ID', 'ì´ë¦„', 'ì„±ë³„', 'ì„¸ëŒ€', 'Line', 'ê´€ê³„', 
        'ì¶œìƒë…„', 'ìƒì¡´ìƒíƒœ', 'ì•„ë²„ì§€', 'ì–´ë¨¸ë‹ˆ', 'ë°°ìš°ì', 
        'ì—°ë½ì²˜', 'ì£¼ì†Œ', 'ì§ì—…', 'ë¹„ê³ '
    ];
    
    const rows = members.map(member => [
        member.id,
        member.name,
        member.gender === 'M' ? 'ë‚¨' : 'ì—¬',
        `${member.generation}ì„¸ëŒ€`,
        member.line,
        member.relationship,
        member.birthYear || '',
        member.status === 'living' ? 'ìƒì¡´' : member.status === 'deceased' ? 'ê³ ì¸' : 'ë¯¸í™•ì¸',
        member.fatherName || '',
        member.motherName || '',
        member.spouseName || '',
        member.phone || '',
        member.address || '',
        member.job || '',
        member.notes || ''
    ]);
    
    return [headers, ...rows]
        .map(row => row.map(cell => `"${cell}"`).join(','))
        .join('\n');
}

// ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { 
        CompleteFamilySystem, 
        demonstrateSystem, 
        quickStartGuide,
        validateSystem,
        exportToJSON,
        exportToCSV
    };
} else {
    // ë¸Œë¼ìš°ì € í™˜ê²½ì—ì„œ ìë™ ì‹¤í–‰
    console.log('ğŸ  í•œì–‘ì¡°ì”¨ ì¡±ë³´ ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ');
}