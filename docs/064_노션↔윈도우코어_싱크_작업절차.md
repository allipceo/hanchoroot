# 064. 노션 데이터 ↔ 윈도우 코어 데이터 동기화 작업 절차

문서 목적: 노션을 기준 마스터로 하여, 규칙 기반 ID 관리와 참조 무결성을 보장하면서 `window.CORE_DATA`를 안전하게 갱신하는 표준 절차 정의. 본 문서는 Notion AI와 협의용 기준안이다.

## 1) 원칙
- 마스터 원칙: Notion DB = 단일 출처(Single Source of Truth), 윈도우 코어 = 배포 산출물.
- 보수적 변경: 유효 ID는 유지. 신규/규칙 불일치/충돌 케이스만 ID 재발급.
- 무결성 우선(코어 반영 전 4종 체크):
  1. ID 형식 100% 일치
  2. ID 유일성 100%
  3. 관계 참조 100% 유효
  4. 변경영향도 리포트 생성·검토 완료
- 가역성 보장: old_id ↔ new_id 전수 매핑 유지(최소 30일).
- 역할 분리: Notion=소스·검수·리포팅, 계산/검증/발급 자동화=스크립트 담당.

## 2) 사전 준비 (스테이징)
1. 노션 원본 DB 복제 → `ID 재발급 스테이징` 생성.
2. 규칙 고정: `docs/050_한양조씨_족보_ID_생성규칙_최종확정본.md` 버전 명시 후 사용.
3. 스테이징 보조 컬럼 추가:
   - 변경유형(select): 신규, 수정, 재발급, 삭제보류
   - 검증상태(status): 미검증, 실패, 보류, 통과
   - 규칙위반코드(multi_select): ID_FORMAT, ID_DUP, REF_MISSING, REF_AMBIG
   - 변경시각(date), 변경사유(text)
4. 백업 스냅샷: 노션 Export(JSON/CSV), 현 코어 파일 보관
5. 별도 데이터 소스: `ID 매핑 테이블(old_id,new_id,reason,ts,operator)`

## 3) ID 발급/정리 (하이브리드)
1. 대상 범위 식별: 신규/수정/규칙 불일치/중복 의심 레코드.
2. 전수 검사(스크립트): 정규식·유일성·참조 사전 스캔 → 스테이징 `검증상태/규칙위반코드` 반영.
3. ID 정책:
   - 기존 유효 ID 유지
   - 신규는 규칙대로 생성(`Lx-Gy-[M|F]-[S|D|H|W]-NNN`)
   - 규칙 불일치/중복은 재발급 후 `ID 매핑 테이블` 기록
4. 형식/중복 재검증로 마감

## 4) 참조 무결성 검증 (스크립트 주도)
검증 대상: `relationships.father/mother/spouses/children/siblings`
- 이름→ID 해석 우선순위: (1) 이름+세대 (2) 이름+부모조합 (3) 이름+ID prefix
- 1:N 후보 발생 시 스테이징에 “수동 검토 큐” 플래그 및 후보 주석 삽입
- 모든 참조가 유효 ID로 연결되는지 확인, 실패 목록은 보류로 분리

## 5) 동기화 실행 (Export → 변환 → 반영)
1. 노션 Export(JSON)
2. 정렬 기준: ID 오름차순(안정 비교를 위해)
3. 비교/병합 규칙
   - 동일 ID: 필드 단위 비교 후 변경분만 업데이트
   - 신규 ID: 그대로 추가
   - 코어에만 있고 노션엔 없는 ID: 보류 목록으로 리포트(삭제는 별도 승인 후)
4. 스키마 준수: 필드명/구조 변경 금지, 허용 변경은 값만
5. 결과물 생성: `data/window_core_data_YYYY-MM-DDTHH-mm-ss.js`
6. 승인 게이트: 검증상태=통과·규칙위반코드=없음·리포트 확인 후 코어 반영

## 6) 사후 검증
1. 무결성 스크립트 결과
   - ID 형식 100% 일치, 중복 0건
   - 관계 참조 100% 유효
2. 앱 스모크 테스트(+콘솔 에러 0건)
   - `app/calculator.html`/`app/detail.html` 정상 로드
   - 예외 배너(사용자 재설정 유도) 미표시
   - 대표 케이스 계산: 1촌/2촌/4촌 OK
3. 대표 인물 샘플 20건 회귀 체크 통과

## 7) 롤백 전략
- 문제 발견 시 old 코어 파일로 즉시 교체
- 노션 측 ID는 매핑표를 사용해 역변환 가능
 - 코어 파일 버전 태깅과 배포 태그를 일치시켜 추적성 확보

## 8) 산출물 목록
- 동기화 리포트: 추가/갱신/보류 건수 및 목록
- 불일치 리포트: 누락 참조, 규칙 위반, 중복 ID
- old↔new 매핑 CSV
- 신규 `window_core_data_*.js`
  
지표(필수): 추가 N, 갱신 M, 보류 K, 규칙 위반 R, 참조 실패 U

## 9) Notion AI에 묻고 싶은 사항
1. 규칙 기반 ID 자동 발급을 워크플로(버튼/자동화)로 구현 가능 여부와 추천 방식
2. 부모/배우자/자녀/형제 참조를 “이름→ID”로 해석/검증하는 최적의 방법
3. 전수 중복 검사 및 형식 검증을 노션 내에서 자동화하는 모범 패턴
4. 변경 이력(신규/수정/재발급)을 태깅/필터로 관리하는 방법
5. 대량 업데이트 시 권장 배치 크기와 성능/속도 팁

## 10) 실행 체크리스트
- [ ] 스테이징 DB 준비/백업 완료
- [ ] 규칙 버전 고정 확인(050 문서)
- [ ] 스테이징 보조 컬럼(변경유형/검증상태/규칙위반코드/변경시각) 추가
- [ ] `ID 매핑 테이블` 생성(권한/보존 정책 포함)
- [ ] 신규/수정/불일치 범위 확정
- [ ] 전수 검사(형식/유일성/참조) 실행 및 스테이징 상태 반영
- [ ] ID 발급/재발급 및 매핑표 완성
- [ ] 승인 게이트 통과
- [ ] 코어 생성 + 스모크/콘솔0건/샘플20 회귀 통과
- [ ] 리포트/매핑/백업 보관

부록) 자동화 스크립트 제안(향후)
- validate_id_format: 정규식 검사 `^L[1-6]-G[1-6]-(M|F)-(S|D|H|W)-\\d{3}$`
- validate_uniqueness: ID 유일성 검사
- validate_references: 이름→ID 해석·참조 유효성 검사(수동 검토 큐 분기)
- compare_by_id: 노션 Export JSON vs 코어 JS 비교(diff JSON 생성)
- apply_updates: diff 반영하여 코어 JS 재생성
배치 권장: 100~200건, 지수백오프·재시도 포함


