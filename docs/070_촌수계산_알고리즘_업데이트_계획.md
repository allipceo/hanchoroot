# 070. 촌수계산 알고리즘 업데이트 계획(058 반영 확장판)

작성일: 2025-09-18
작성자: 서대리
대상: 한양조씨 족보앱 촌수계산 기능(058 보고서 기반, 외가/호칭/방어로직 보강)

## 1) 개요
- 본 문서는 058 보고서의 알고리즘을 바탕으로, 나실장/조대표 지침을 통합하여 촌수 계산의 정확도와 일관성을 강화하는 업데이트 계획이다.
- 핵심 보강점: 부/모 모두 상향 탐색, 외가(모계) 경로 처리, 배우자 경로 제외, 동명이인 대비 ID 기반 판정, 호칭 표준화, 방어/검증 로직, 테스트 확장.

## 2) 058 대비 주요 개선 사항 요약
1. 상향 탐색: father-only → father+mother 동시 탐색(BFS/레이어 탐색)로 공통조상(LCA) 정확도 향상
2. 외가 처리: 모계를 경유한 연결 시 “외” 접두 적용 규칙 명시화(조씨 딸의 자녀 포함)
3. 배우자: 촌수 경로에서 제외(표시는 "배우자", degree=0)
4. 성씨/ID 판정: 이름 접두(‘조’) 의존 최소화 → ID/스키마 기반 판정 함수로 일원화(임시 fallback 허용)
5. 타이틀: 1=부모/자녀, 2=형제/자매, 3=삼촌/조카, 4=사촌 … + 외가 시 ‘외’ 접두
6. 방어로직: 공통조상 다수 시 최단 합 경로 선택, 부모 null 허용, 사이클 가드, 데이터 누락 허용 처리
7. 테스트: 조씨/외가/배우자/자기자신/형제/사촌/사촌-외 등 20건 이상으로 확대

## 3) 데이터 및 입력 기준(변경 없음 + 보강)
- 입력: 인물 ID 2개(브라우저에서는 이름 검색→ID 매핑 후 사용)
- 데이터: `window.CORE_DATA` 각 인물 레코드
  - 필드: `id`, `name`, `세대`, `relationships.father/mother/spouses/children`
- 판정 기본: ID 기반 일치(동명이인 무관), 배우자 경로는 계산에서 제외

## 4) 알고리즘 원칙(업데이트)
1) 공통조상 기준(최단 합)
- 두 사람의 가장 가까운 공통조상까지의 상향 거리 합으로 촌수 계산
- 거리 정의는 1-기반(부=1, 조부=2)

2) 상향 탐색 경로
- 부/모 모두 상향 탐색(BFS). 각 경로에 `passedMaternal`(모계를 거쳤는지) 플래그 기록
- 공통조상 후보가 여럿이면 `(A→조상) + (B→조상)` 합이 최소인 후보 채택

3) 조씨/외가 규칙
- 기본: 조씨↔조씨 간 촌수 계산
- 예외(외가 허용): 한쪽이 비-조씨여도 모계를 통해 조씨 공통조상과 연결되는 경우 유효. 결과 호칭/표기에 ‘외’ 접두 적용

4) 배우자
- 촌수 계산 경로에서 제외. 당사자 간 배우자면 degree=0, title="배우자"

5) 예외 처리
- 자기 자신: 0촌("나")
- 공통조상 없음: 계산 불가(오류 메시지)
- 데이터 누락: 부모 null 허용, 가능한 범위에서 계산

## 5) 설계 변경 사항(핵심 함수)
- getParents(person): father/mother 동시 반환
- buildAncestorMap(start): BFS로 상향 탐색하며 `{dist, passedMaternal}` 저장
- findBestCommon(ancA, ancB): 공통 key 중 최단 합(degree) 후보 선택(동률 시 임의 1개)
- isChoSurname(person): ID/스키마 기반으로 조씨 여부 판단(임시로 name[0]=="조" fallback 허용)
- formatTitle(degree, isMaternal): 외가 접두 및 기본 호칭 매핑 일원화

### 5.1 의사코드
```pseudo
function calculateChonsu(idA, idB):
  if idA == idB: return { chonsu:0, title:"나" }
  A := person(idA), B := person(idB)
  if spouse(A)==B or spouse(B)==A: return { chonsu:0, title:"배우자" }

  ancA := buildAncestorMap(A)  // includes A self at dist=0
  ancB := buildAncestorMap(B)  // includes B self at dist=0

  best := null
  for each id in ancA.keys ∩ ancB.keys:
    d := ancA[id].dist + ancB[id].dist
    if best == null or d < best.chonsu:
      best := { id, chonsu:d, mA:ancA[id].passedMaternal, mB:ancB[id].passedMaternal }

  if best == null: return { error:"공통조상 없음" }

  bothCho := isChoSurname(A) and isChoSurname(B)
  maternalPath := best.mA or best.mB
  if not bothCho and not maternalPath:
    return { error:"규칙상 계산 불가(성씨/경로 불일치)" }

  isMaternal := maternalPath and (not isChoSurname(A) or not isChoSurname(B))
  title := formatTitle(best.chonsu, isMaternal)
  return { chonsu: best.chonsu, title, commonAncestor: best.id }
```

### 5.2 타이틀 규칙 표준화(간단형)
- 1: 부모/자녀
- 2: 형제/자매
- 3: 삼촌/조카
- 4: 사촌
- 5+: "N촌"
- 외가(모계 경로)인 경우 접두 "외" 부여(예: 외삼촌, 외사촌, 외5촌)

## 6) 검증/방어 로직
- 다중 공통조상: 최단 합 경로 채택(동률 시 첫 후보)
- 사이클 가드: 상향 방문 집합으로 재방문 차단
- 부모 미상(null) 허용: 탐색 중단 지점으로 처리
- 데이터 무결성 경고: 자기 자신 외 동일인 입력 시 경고

## 7) 예제 시나리오(승인 기준 케이스)
- 예제 A: 조광희 ↔ 조원상
  - 공통조상: 조동하
  - 계산: (조광희→조은상 1 → 조동하 2) + (조원상→조동하 1) = 3촌
  - 결과: 3촌, 호칭: 삼촌/조카 계열

- 예제 B: 전종일 ↔ 조원상(외가)
  - 관계: 전종일(조아영의 아들), 조아영(조동하의 딸), 조원상(조동하의 아들)
  - 계산: 조원상→조동하(1) + 조동하→조아영(1) + 조아영→전종일(1) = 3촌
  - 결과: 외3촌, 호칭: 외삼촌/외조카

## 8) 테스트 계획(20+ 케이스)
- 카테고리
  - 자기자신(0), 배우자(0), 부모/자녀(1), 조부/손자(2)
  - 형제/자매(2), 삼촌/조카(3), 사촌(4), 5촌 이상(N)
  - 외가(외삼촌/외사촌/외5촌 등), 조씨↔비조씨(모계 경유 허용), 공통조상 없음
- 구현
  - `data/chonsu_comprehensive_test.js` 확장(20~30 케이스)
  - 브라우저 콘솔 자동검증 + 요약 리포트 출력

## 9) UI 반영(요약)
- 결과 표시부: 외가일 경우 ‘외’ 접두 포함해 타이틀/설명 출력
- 입력 흐름: 기존과 동일(이름 2개 또는 ‘나→대상’), ID 매핑은 중복명 대비
- 오류 메시지: 공통조상 없음/규칙상 계산 불가 시 명확 알림

## 10) 이행 계획(일정)
1. 엔진 보강(부/모 상향 + 외가 플래그 + 최단합)
2. 타이틀 표준화/포매터 적용
3. 테스트 20+ 준비 및 자동화
4. UI 결과 문자열/배너 보완
5. 문서/리포트 업데이트(본 문서, 056 갱신 사항 반영)
- 예상: 0.5일 설계/코딩, 0.5일 테스트/문서, 총 1일

## 11) 산출물
- 코드: `js/chonsu_engine.js`(브라우저), `data/chonsu_engine.js`(소스)
- 테스트: `data/chonsu_comprehensive_test.js`(확장)
- 문서: 본 문서(070), 필요시 056 업데이트 섹션 추가

## 12) 승인 기준(출시 게이트)
- 예제 A/B 포함 20+ 테스트 전부 통과
- 외가 접두 표기 일관성 검증
- 배우자 경로 제외 규칙 검증
- 동명이인(4명) 환경에서 ID 기준 오판정 없음

## 13) 리스크 및 대응
- 성씨 판정 근거 부족: 단기 이름 접두 fallback, 중기 ID/스키마 고정
- 데이터 누락/오류: 경고+부분 계산, 추후 데이터 정비 계획 수립
- 성능: 현재 데이터 규모에서 BFS 상향 탐색은 실시간 무리 없음(수백~수천 레코드 기준)

## 14) 실행 결과(2025-09-18)
- 테스트 실행: `node data/chonsu_comprehensive_test.js`
- 수집 케이스: 27건(자기자신/부모자녀/형제/사촌/배우자/외가 일부)
- 결과: 27/27 통과, 배우자 0촌 처리 확인, 외가 경로 테스트 포함
- 분포 리포트: 조씨 67명 기준 시조 대비 촌수 분포 출력(3~4촌 다수)

## 15) 후속 조치
- 외가 케이스 추가(외사촌 5촌 등)로 테스트 보강 예정
- 성씨 판정 함수를 ID/스키마 기반으로 교체(이름 접두 의존 제거)
- 056 문서 결과/레슨 업데이트 반영


