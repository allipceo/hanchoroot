# 065. 노션 데이터 ↔ 윈도우 코어 데이터 동기화 작업 절차 v2.0

문서 목적: Notion을 마스터로, `window.CORE_DATA`를 배포 산출물로 관리하는 동기화 표준의 v2.0. v1.0(064) 대비 운영 안정성·재현성·검증 강도를 강화했다.

## 0) 변경점 요약 (v1.0 → v2.0)
- 무결성 4종 체크를 “승인 게이트”로 고정 (형식/유일성/참조/영향도 리포트)
- 스테이징 보조 컬럼(변경유형/검증상태/규칙위반코드/변경시각/사유) 및 `ID 매핑 테이블` 운영
- 이름·부모 필드 정규화(유니코드 NFKC, 공백·기호 정리)와 보조키로 동명이인 모호성 저감
- 참조 무결성 추가 규칙(배우자 양방향, 부모-자녀 양방향, 순환·자기참조 금지)
- Export/코어 산출물 해시(SHA-256) 기록으로 재현성·롤백 신뢰도 강화
- 스크립트 실행 환경 고정(Node 버전/lockfile/타임존)과 Dry-run 의무화
- 부분 승인 배치, 체크포인트, 배치 크기 지침(100~200) 도입

## 1) 원칙
- 마스터: Notion DB = 단일 출처(Single Source of Truth)
- 산출물: 윈도우 코어 = 배포용 빌드 결과물
- 보수적 변경: 유효 ID 유지, 신규/불일치/중복만 재발급(매핑 유지 ≥30일)
- 역할 분리: Notion=소스·검수·리포팅, 스크립트=계산·검증·발급·변환
- 승인 게이트(필수):
  1. ID 형식 100%
  2. ID 유일성 100%
  3. 참조 무결성 100%
  4. 변경영향도 리포트 확인

## 2) 사전 준비(스테이징)
1. 원본 DB 복제 → `ID 재발급 스테이징`
2. 규칙 고정: `docs/050_한양조씨_족보_ID_생성규칙_최종확정본.md`
3. 보조 컬럼 추가:
   - 변경유형(select): 신규, 수정, 재발급, 삭제보류
   - 검증상태(status): 미검증, 실패, 보류, 통과
   - 규칙위반코드(multi_select): ID_FORMAT, ID_DUP, REF_MISSING, REF_AMBIG, REF_CONFLICT, GEN_MISMATCH, CYCLE
   - 변경시각(date), 변경사유(text), 작업자(person)
4. `ID 매핑 테이블`(old_id,new_id,reason(code),ts,operator)
5. 백업 스냅샷: Notion Export(JSON/CSV), 현 코어 파일 보관
6. 실행 환경 고정: Node LTS, package-lock.json, TZ=Asia/Seoul

## 3) 데이터 정규화·색인(스크립트)
- normalize_names: 유니코드 NFKC, 다중 공백·기호 제거, 비교 키 생성
- make_ref_index: (정규화이름+세대+부모축약키) 역색인 생성
- 금지 패턴 사전 차단: 자기배우자/자기부모 등

## 4) ID 발급/정리(하이브리드)
1. 대상 식별: 신규/수정/규칙 불일치/중복 의심
2. 전수 검사: 정규식 `^L[1-6]-G[1-6]-(M|F)-(S|D|H|W)-\d{3}$`, 유일성, 참조 사전 스캔 → 스테이징 `검증상태/규칙위반코드` 반영
3. ID 정책:
   - 유효 ID 유지
   - 신규 ID 발급(필요 시 plan_id_ranges로 배치 prefix 예약)
   - 재발급 시 사유 코드(RULE_MISMATCH, DUP_FIX, MERGE, SPLIT) 기록 + 매핑 테이블 반영

## 5) 참조 무결성(스크립트 주도)
- 이름→ID 해석 우선순위: ①정규화이름+세대 ②정규화이름+부모축약키 ③이름+ID prefix
- 상호참조 규칙: 배우자 양방향, 부모-자녀 양방향(형제는 부모를 통해 간접 확인)
- 금지 검사: 순환/자기참조/세대 역행 → 규칙위반코드=CYCLE
- 다중 후보: 수동 검토 큐로 분기, 후보/점수 주석 반영

## 6) 동기화 실행(Export → 변환 → 반영)
1. Notion Export(JSON) + write_artifact_hash(SHA-256) 저장
   - meta.json 함께 작성: { sha256, node_version, tz, script_commit, sorted_by: ["id","name"], count }
2. ID 기준 오름차순 정렬 후 compare_by_id(diff 생성)
3. Dry-run: diff 리포트 리뷰(변경유형/영향도 지표 포함)
4. 승인 게이트 통과 후 apply_updates로 코어 JS 생성
5. 코어 파일 해시 기록(배포 태그와 해시 동기화)
6. 부분 승인 옵션: 통과분만 선반영, 실패/보류는 큐 유지
   - 부분 승인 경계 조건(권장): 참조 실패·순환=0 이고 규칙위반코드가 ID_FORMAT/ID_DUP 만 존재하는 건은 제외하여 보류 처리

## 7) 사후 검증
- validate_id_format/uniqueness/references 통과
- 앱 스모크 + 브라우저 콘솔 에러 0건
- 대표 샘플 20건 회귀(고정 세트) + 회전형 20건 변화 감지
 - 영향도 리포트 고정 지표: 재발급 비율 R%, 참조 수리 U, 삭제보류 K, 후보모호 C

## 8) 운영·권한·기록
- 스테이징/매핑 테이블: 작업자/사유/시각 자동기록 원칙
- 체크포인트 파일로 재시작 가능(배치 100~200, 레코드 크면 50~100)
- API 지수백오프·재시도, PATCH 최소화(no-op 회피)
 - 스테이징 뷰 구성: 실패 / 보류(모호 후보 포함) / 통과 3개 테이블 + 리포트 뷰

## 9) 롤백 전략
- 문제 시 이전 코어 파일로 즉시 교체
- old↔new 매핑에 따라 역변환 자동화 지원
- 스냅샷/해시/배포 태그로 추적성 보장

## 10) 산출물·지표
- 동기화 리포트: 추가 N, 갱신 M, 보류 K, 재발급 R, 참조 수리 U, 동명이인 해소 C
- 불일치/오류 리포트: 규칙 위반, 참조 실패, 순환 등
- 산출물 해시: Notion Export, 코어 JS

## 11) 실행 체크리스트
- [ ] 스테이징 DB/보조 컬럼/매핑 테이블 준비
- [ ] 이름 정규화 규칙 적용 및 색인 생성
- [ ] 전수 검사(형식/유일성/참조/순환) 통과
- [ ] ID 발급·재발급 및 매핑 테이블 확정
- [ ] Export 스냅샷/해시 기록
- [ ] Dry-run diff 생성·리뷰·승인 기록
- [ ] 승인 게이트 통과 후 코어 생성
- [ ] 앱 스모크/콘솔0/샘플 회귀 통과
- [ ] 리포트·매핑·스냅샷·해시 보관

## 12) 자동화 스크립트 함수(권장)
- normalize_names, make_ref_index, validate_id_format, validate_uniqueness, validate_references
- validate_cycles, plan_id_ranges, compare_by_id, apply_updates, write_artifact_hash
 - score_candidates(후보 점수/랭크), enforce_bidirectional(양방향 보정), sanitize_text(텍스트 정리), report_metrics(지표 산출)

부록) 환경 고정 예시
- Node: LTS(예: 20.x), package-lock.json 커밋
- TZ: Asia/Seoul
