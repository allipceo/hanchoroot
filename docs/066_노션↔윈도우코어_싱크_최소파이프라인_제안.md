# 066. 노션↔윈도우코어 싱크 최소 파이프라인 제안

목적: 복잡도를 낮추고 실패 표면적을 줄이면서, 핵심 무결성만 확인하고 신속·안전하게 동기화하기 위한 "얇고 견고한" 절차.

## A) 운영 원칙
- 마스터=Notion, 코어=배포 산출물(불변)
- 기능은 최소, 검증은 충분(핵심 4종만): 형식, 유일성, 참조, 영향도
- Dry-run 의무화, 해시·스냅샷으로 재현성/롤백 보장
- 설정 주도(config.json), 배치 고정(100→문제 시 50)

## B) 필수 4종 체크(승인 게이트)
1. validate_id_format: `^L[1-6]-G[1-6]-(M|F)-(S|D|H|W)-\d{3}$`
2. validate_uniqueness: ID 중복=0
3. validate_references: 이름+세대만 사용(기본). 실패=치명, 모호=보류
4. 영향도 리포트 생성: add/update/hold/reissued/ref_fixed

## C) 두 가지 운영 모드(상황별 선택)
- 모드 1: 전량 덮어쓰기(overwrite)
  - 조건: 4종 통과, 스키마 일치, 삭제 정책 확정
  - 처리: Notion ID 오름차순 → 코어 전량 교체, 코어에만 있는 ID는 삭제보류 리스트로
- 모드 2: 부분 승인(partial apply) [기본]
  - 조건: 4종 통과 + 실패/보류 건 존재
  - 처리: 통과분만 반영, 실패/보류는 다음 배치로 이월

## D) 실행 절차(슬림)
1) Export(JSON) → meta.json 기록: {sha256, node, tz, commit, sorted_by:[id,name], count}
2) 4종 체크 수행 → Dry-run diff 생성(compare_by_id)
3) 승인(게이트 통과) → apply_updates(모드 1 또는 모드 2)
4) 코어 파일 생성 + 해시 기록 + 배포 태그

## E) 설정 파일 기본값(config.json 예시)
```json
{
  "normalize": { "basic_only": true },
  "advanced_rules": { "cycles": false, "deep_name_norm": false },
  "partial_approval": true,
  "batch": { "size": 100, "fallback": 50 },
  "report": { "metrics": ["add","update","hold","reissued","ref_fixed"] }
}
```

## F) 안전장치
- Dry-run 없이는 apply 금지
- 롤백: 직전 코어 파일과 매핑표, meta.json, 해시로 즉시 복귀
- 로그: 구조화(JSON) 1파일(metrics.json)만 생성

## G) 성공 기준
- ID 형식/유일성/참조 100% 통과(보류는 0 또는 다음 배치로 이월)
- 앱 스모크 통과, 콘솔 에러 0, 대표 샘플 20 회귀 OK
- 영향도 리포트 산출(최소 5지표)

## H) 최소 스크립트 구성(파일명 권장)
- validate_id_format.js
- validate_uniqueness.js
- validate_references.js
- compare_by_id.js
- apply_updates.js
- write_artifact_hash.js
- 공통: utils.js(config 로드, 정렬, 로깅)

## I) 운영 메모
- 처음 2~3회는 모드 2(부분 승인)로 안정화 → 이후 모드 1(덮어쓰기) 전환 가능
- 규칙/정책 변경은 문서(065 v2.0)에만 반영하고, 코드는 플래그로 제어

본 제안은 단순화와 안정성을 우선합니다. 필요 시 정규화/순환검사 등 고급 규칙은 플래그로 단계적 활성화하세요.
